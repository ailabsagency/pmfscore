(code from earlier truncated for brevity)